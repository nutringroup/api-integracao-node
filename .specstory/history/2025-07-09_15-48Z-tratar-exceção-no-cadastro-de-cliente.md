<!-- Generated by SpecStory -->

# Tratar exce√ß√£o no cadastro de cliente (2025-07-09 15:48Z)

_**User**_

precisamos tratar uma exce√ßao no retorno do omie no momento de cadastro do cliente : 	
"faultcode": "SOAP-ENV:Client-102"


2025-07-09 15:13:15.715	
"faultstring": "ERROR: Cliente j√° cadastrado para o C√≥digo de Integra√ß√£o [7325099098244] com o nCod [2274524288] !",
2025-07-09 15:13:15.715	
"response": {
2025-07-09 15:13:15.715	
"error": "Request failed with status code 500",
2025-07-09 15:13:15.715	
"attempt": 2,
2025-07-09 15:13:15.715	
"call": "IncluirCliente",
2025-07-09 15:13:15.715	
"endpoint": "/geral/clientes/",
2025-07-09 15:13:15.715	
{
2025-07-09 15:13:15.715	
2025-07-09 18:13:15 [error]: OMIE API Request Error


para que use o id existente para atualizar o cliente

---

_**Assistant**_

Vou analisar o c√≥digo para entender como est√° sendo tratado o cadastro de clientes no Omie e implementar o tratamento da exce√ß√£o para usar o ID existente quando o cliente j√° estiver cadastrado.

---

<details>
            <summary>Searched codebase "cadastro cliente Omie IncluirCliente" ‚Ä¢ **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/services/OmieService.js` | L313-383 |
| `src/services/OmieService.js` | L627-659 |
| `src/services/OmieService.js` | L599-627 |
| `src/jobs/SendToOmieJob.js` | L58-111 |
| `src/services/OmieService.js` | L227-295 |
| `src/services/OmieService.js` | L487-532 |
| `src/services/OmieService.js` | L390-446 |
| `src/models/Client.js` | L1-46 |
| `src/services/OmieService.js` | L383-390 |
| `src/services/OmieService.js` | L446-487 |
| `src/jobs/SendToOmieJob.js` | L11-58 |
| `src/services/OmieService.js` | L532-599 |
| `MELHORIAS-IMPLEMENTADAS.md` | L39-76 |
| `src/jobs/SendToOmieJob.js` | L559-591 |
| `src/jobs/SendToOmieJob.js` | L179-225 |
| `STEPS-MAPPING.md` | L1-55 |
| `src/controllers/OrderController.js` | L11-94 |
| `src/jobs/SendToOmieJob.js` | L225-262 |
| `src/services/OmieService.js` | L295-313 |
| `STEPS-MAPPING.md` | L55-104 |
| `src/services/OmieService.js` | L1-24 |
| `src/services/OmieService.js` | L24-53 |
| `MELHORIAS-IMPLEMENTADAS.md` | L1-39 |
| `src/services/OmieService.js` | L734-774 |
| `src/jobs/SendToOmieJob.js` | L146-179 |

</details>

---

Agora vou procurar especificamente pelo tratamento do erro "SOAP-ENV:Client-102" e "Cliente j√° cadastrado para o C√≥digo de Integra√ß√£o":

---

<details>
            <summary>Grep search for "SOAP-ENV:Client-102" ‚Ä¢ **0** files</summary>
        
No results found
</details>

---

<details>
            <summary>Grep search for "Cliente j√° cadastrado para o C√≥digo de Integra√ß√£o" ‚Ä¢ **0** files</summary>
        
No results found
</details>

---

<details>
            <summary>Grep search for "nCod" ‚Ä¢ **4** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/server.js` | L88 | `app.use(express.urlencoded({ extended: true, limit: '10mb' }));` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/jobs/SendToOmieJob.js` | L363 | `let productIntegrationCode = null;` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/jobs/SendToOmieJob.js` | L385 | `productIntegrationCode = product.codigo_produto_integracao;` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/jobs/SendToOmieJob.js` | L445 | `productIntegrationCode = null;` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/jobs/SendToOmieJob.js` | L454 | `codigo_produto_integracao: productIntegrationCode,` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/package-lock.json` | L2666 | `"node_modules/bull-board/node_modules/encodeurl": {` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/package-lock.json` | L2668 | `"resolved": "https://registry.npmjs.org/encodeurl/-/encodeurl-1.0.2.tgz",` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/package-lock.json` | L2690 | `"encodeurl": "~1.0.2",` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/package-lock.json` | L2723 | `"encodeurl": "~1.0.2",` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/package-lock.json` | L2825 | `"encodeurl": "~1.0.2",` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/package-lock.json` | L2846 | `"encodeurl": "~1.0.2",` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/package-lock.json` | L3571 | `"node_modules/encodeurl": {` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/package-lock.json` | L3573 | `"resolved": "https://registry.npmjs.org/encodeurl/-/encodeurl-2.0.0.tgz",` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/package-lock.json` | L4020 | `"encodeurl": "~2.0.0",` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/package-lock.json` | L4244 | `"encodeurl": "~2.0.0",` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/package-lock.json` | L7189 | `"encodeurl": "~1.0.2",` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/package-lock.json` | L7204 | `"node_modules/send/node_modules/encodeurl": {` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/package-lock.json` | L7206 | `"resolved": "https://registry.npmjs.org/encodeurl/-/encodeurl-1.0.2.tgz",` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/package-lock.json` | L7319 | `"encodeurl": "~2.0.0",` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/shopify-omie-front/.specstory/history/2025-07-08_14-18Z-definir-url-no-arquivo-env.md` | L4519 | `ync ()=\u003e{\\n        // Since all we're doing is decoding and re-encoding a cached prerende` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/shopify-omie-front/.specstory/history/2025-07-08_14-18Z-definir-url-no-arquivo-env.md` | L4610 | `object \\\"dynamic\\\". Since we are in dynamicIO mode\\n                    // we encode this` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/shopify-omie-front/.specstory/history/2025-07-08_14-18Z-definir-url-no-arquivo-env.md` | L4709 | `entParam.param):Array.isArray(value1)?value1=value1.map(i=\u003eencodeURIComponent(i)):\\\"stri` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/shopify-omie-front/.specstory/history/2025-07-08_14-18Z-definir-url-no-arquivo-env.md` | L4710 | `ng\\\"==typeof value1\u0026\u0026(value1=encodeURIComponent(value1)),!value1){let isCatchall=\\` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/shopify-omie-front/.specstory/history/2025-07-08_14-18Z-definir-url-no-arquivo-env.md` | L5116 | `ngRouteTree = async ()=\u003e{\\n        // Since all we're doing is decoding and re-encoding a` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/shopify-omie-front/.specstory/history/2025-07-08_14-18Z-definir-url-no-arquivo-env.md` | L5208 | `/ we encode this as a promise that never resolves\\n                    return (0, _dynamicrend` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/shopify-omie-front/.specstory/history/2025-07-08_14-18Z-definir-url-no-arquivo-env.md` | L5306 | `eParams.get(segmentParam.param):Array.isArray(value1)?value1=value1.map(i=\u003eencodeURICompon` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/shopify-omie-front/.specstory/history/2025-07-08_14-18Z-definir-url-no-arquivo-env.md` | L5307 | `ent(i)):\\\"string\\\"==typeof value1\u0026\u0026(value1=encodeURIComponent(value1)),!value1){l` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/shopify-omie-front/.specstory/history/2025-07-08_14-18Z-definir-url-no-arquivo-env.md` | L6072 | `ngRouteTree = async ()=\u003e{\\n        // Since all we're doing is decoding and re-encoding a` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/shopify-omie-front/.specstory/history/2025-07-08_14-18Z-definir-url-no-arquivo-env.md` | L6164 | `/ we encode this as a promise that never resolves\\n                    return (0, _dynamicrend` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/shopify-omie-front/.specstory/history/2025-07-08_14-18Z-definir-url-no-arquivo-env.md` | L6262 | `eParams.get(segmentParam.param):Array.isArray(value1)?value1=value1.map(i=\u003eencodeURICompon` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/shopify-omie-front/.specstory/history/2025-07-08_14-18Z-definir-url-no-arquivo-env.md` | L6263 | `ent(i)):\\\"string\\\"==typeof value1\u0026\u0026(value1=encodeURIComponent(value1)),!value1){l` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/shopify-omie-front/.specstory/history/2025-07-08_14-18Z-definir-url-no-arquivo-env.md` | L6866 | `ngRouteTree = async ()=\u003e{\\n        // Since all we're doing is decoding and re-encoding a` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/shopify-omie-front/.specstory/history/2025-07-08_14-18Z-definir-url-no-arquivo-env.md` | L6958 | `/ we encode this as a promise that never resolves\\n                    return (0, _dynamicrend` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/shopify-omie-front/.specstory/history/2025-07-08_14-18Z-definir-url-no-arquivo-env.md` | L7056 | `eParams.get(segmentParam.param):Array.isArray(value1)?value1=value1.map(i=\u003eencodeURICompon` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/shopify-omie-front/.specstory/history/2025-07-08_14-18Z-definir-url-no-arquivo-env.md` | L7057 | `ent(i)):\\\"string\\\"==typeof value1\u0026\u0026(value1=encodeURIComponent(value1)),!value1){l` |

</details>

---

Vou analisar melhor o c√≥digo atual para entender como est√° sendo tratado o erro de cliente j√° cadastrado:

---

Read file: src/services/OmieService.js

---

Agora vou analisar o erro espec√≠fico que est√° ocorrendo. Vou ver se o erro est√° sendo tratado corretamente no m√©todo `createClient`:

---

Read file: src/services/OmieService.js

---

Agora vou analisar o erro espec√≠fico que est√° ocorrendo. O erro √©:

```
"faultcode": "SOAP-ENV:Client-102"
"faultstring": "ERROR: Cliente j√° cadastrado para o C√≥digo de Integra√ß√£o [7325099098244] com o nCod [2274524288] !"
```

O problema √© que o c√≥digo atual est√° procurando por "Cliente j√° cadastrado para o CPF/CNPJ" mas o erro real √© "Cliente j√° cadastrado para o C√≥digo de Integra√ß√£o". Vou corrigir isso:

---

```diff
        'Pedido n√£o cadastrado para o C√≥digo de Integra√ß√£o', // Erro esperado
        'Cliente j√° cadastrado para o CPF/CNPJ', // Erro esperado - cliente existe
+       'Cliente j√° cadastrado para o C√≥digo de Integra√ß√£o', // Erro esperado - cliente existe com c√≥digo integra√ß√£o
        'n√£o faz parte da estrutura',
        'Tag [CODIGO_PRODUTO] n√£o faz parte',
```

---

Agora vou atualizar o m√©todo `createClient` para tratar especificamente o erro "Cliente j√° cadastrado para o C√≥digo de Integra√ß√£o" e extrair o `nCod`:

---



---

Agora vou tamb√©m atualizar o m√©todo `updateClient` para tratar o mesmo erro:

---



---

Agora vou tamb√©m tratar o erro no bloco `catch` do m√©todo `createClient` para garantir que ambos os tipos de erro sejam tratados:

---



---

Agora vou criar um log espec√≠fico para registrar quando o tratamento da exce√ß√£o √© aplicado:

---



---

Agora vou fazer o mesmo para o m√©todo `updateClient`:

---



---

Agora vou tamb√©m adicionar o mesmo log para o primeiro tratamento no m√©todo `createClient`:

---



---

Agora vou atualizar o arquivo de documenta√ß√£o das etapas para incluir os novos steps:

---



---

Agora vou criar um teste para verificar se o tratamento est√° funcionando corretamente:

---

```diff
- 
+ const { OmieService } = require('./src/services/OmieService');
+ const { HistoryLog } = require('./src/models');
+ 
+ // Simular dados do Shopify
+ const mockShopifyData = {
+   name: 'TEST-ORDER-123',
+   customer: {
+     id: 7325099098244,
+     email: 'test@example.com'
+   },
+   shipping_address: {
+     name: 'Cliente Teste',
+     address1: 'Rua Teste, 123',
+     city: 'S√£o Paulo',
+     province_code: 'SP',
+     zip: '01234-567',
+     phone: '11999999999'
+   },
+   note_attributes: [
+     {
+       name: 'additional_cpf_cnpj',
+       value: '12345678901'
+     }
+   ]
+ };
+ 
+ // Simular resposta de erro do OMIE
+ const mockErrorResponse = {
+   faultcode: 'SOAP-ENV:Client-102',
+   faultstring: 'ERROR: Cliente j√° cadastrado para o C√≥digo de Integra√ß√£o [7325099098244] com o nCod [2274524288] !',
+   httpCode: 500
+ };
+ 
+ async function testClientIntegrationError() {
+   console.log('üß™ Testando tratamento de erro: Cliente j√° cadastrado para o C√≥digo de Integra√ß√£o');
+   
+   try {
+     const omieService = new OmieService();
+     
+     // Simular o erro extraindo o nCod
+     const faultstring = mockErrorResponse.faultstring;
+     const nCodMatch = faultstring.match(/nCod \[(\d+)\]/);
+     
+     if (nCodMatch && nCodMatch[1]) {
+       const omieClientId = nCodMatch[1];
+       
+       console.log('‚úÖ Regex funcionando corretamente!');
+       console.log('üìã Dados extra√≠dos:');
+       console.log(`   - C√≥digo de Integra√ß√£o: ${mockShopifyData.customer.id}`);
+       console.log(`   - nCod extra√≠do: ${omieClientId}`);
+       console.log(`   - Mensagem original: ${faultstring}`);
+       
+       // Simular salvamento da rela√ß√£o
+       console.log('üíæ Salvando rela√ß√£o cliente...');
+       await omieService.saveClientRelation(omieClientId, mockShopifyData);
+       
+       // Simular cria√ß√£o do log
+       console.log('üìù Criando log de hist√≥rico...');
+       await HistoryLog.create({
+         step: 67,
+         shopify_id: mockShopifyData.name,
+         log: { 
+           status: 'Cliente j√° cadastrado - C√≥digo de Integra√ß√£o tratado (TESTE)',
+           omie_client_id: omieClientId,
+           codigo_integracao: mockShopifyData.customer.id,
+           faultstring: faultstring
+         },
+       });
+       
+       console.log('‚úÖ Teste conclu√≠do com sucesso!');
+       console.log('üéØ O tratamento da exce√ß√£o est√° funcionando corretamente');
+       
+       return { codigo_cliente_omie: omieClientId };
+     } else {
+       console.log('‚ùå Erro: N√£o foi poss√≠vel extrair o nCod da mensagem');
+       console.log(`   Mensagem: ${faultstring}`);
+       return null;
+     }
+     
+   } catch (error) {
+     console.error('‚ùå Erro durante o teste:', error.message);
+     return null;
+   }
+ }
+ 
+ // Executar o teste
+ if (require.main === module) {
+   testClientIntegrationError()
+     .then(result => {
+       if (result) {
+         console.log('\nüéâ Teste bem-sucedido!');
+         console.log(`   Cliente ID: ${result.codigo_cliente_omie}`);
+       } else {
+         console.log('\n‚ùå Teste falhou!');
+       }
+       process.exit(0);
+     })
+     .catch(error => {
+       console.error('\nüí• Erro fatal:', error);
+       process.exit(1);
+     });
+ }
+ 
+ module.exports = { testClientIntegrationError }; 
```

---

Agora vou executar o teste para verificar se tudo est√° funcionando:

---

```bash
cd /Users/antonioduarte/Projects/api.gummy.com.br/backend-node && node test-client-integration-error.js
```

```
üß™ Testando tratamento de erro: Cliente j√° cadastrado para o C√≥digo de Integra√ß√£
o
‚ùå Erro durante o teste: OmieService is not a constructor

‚ùå Teste falhou!

```

---

_**User**_

perfeito, agora temos outra exce√ß√£o para corrigir, quando algum produto vem da shopify com o valor zerado, ele precisa assumir o valor de 16,50 e para o valor total bater na nota, esse valor de 16,50 precisa ser abatido de outros itens do pedido 

---

_**Assistant**_

Vou analisar o c√≥digo atual para entender como os produtos s√£o processados e implementar a l√≥gica para tratar produtos com valor zerado.

---

<details>
            <summary>Searched codebase "processamento produtos line items valor pre√ßo" ‚Ä¢ **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/jobs/SendToOmieJob.js` | L311-364 |
| `src/jobs/SendToOmieJob.js` | L447-465 |
| `src/jobs/SendToOmieJob.js` | L262-311 |
| `src/services/ShopifyService.js` | L436-459 |
| `src/jobs/SendToOmieJob.js` | L364-396 |
| `src/services/ShopifyService.js` | L421-436 |
| `src/jobs/SendToOmieJob.js` | L533-559 |
| `src/jobs/SendToOmieJob.js` | L179-225 |
| `src/jobs/SendToOmieJob.js` | L396-447 |
| `src/jobs/SendToOmieJob.js` | L146-179 |
| `test-gummy-kids-rule.js` | L1-48 |
| `src/services/ShopifyService.js` | L358-386 |
| `src/services/OmieService.js` | L655-722 |
| `test-gummy-kids-rule.js` | L48-93 |
| `src/services/OmieService.js` | L988-1035 |
| `src/models/Product.js` | L1-39 |
| `src/controllers/OrderController.js` | L11-94 |
| `src/services/ShopifyService.js` | L404-421 |
| `src/jobs/SendToOmieJob.js` | L11-58 |
| `MELHORIAS-IMPLEMENTADAS.md` | L1-39 |
| `STEPS-IMPLEMENTATION-SUMMARY.md` | L1-52 |
| `MELHORIAS-IMPLEMENTADAS.md` | L39-76 |
| `src/workers/index.js` | L1-18 |
| `src/services/OmieService.js` | L948-968 |
| `src/services/OmieService.js` | L148-210 |

</details>

---

Agora vou analisar especificamente o processamento dos itens para entender como implementar a l√≥gica de produtos com valor zerado:

---

Read file: src/jobs/SendToOmieJob.js

---

Agora vou implementar a l√≥gica para tratar produtos com valor zerado. Vou criar um novo m√©todo que ajusta os pre√ßos dos produtos:

---

```diff
        const lineItems = await this.processLineItems(shopifyData);
        const totalQty = lineItems.length;
+ 
+       // Ajusta pre√ßos de produtos zerados
+       const adjustedLineItems = await this.adjustZeroPriceProducts(lineItems, shopifyData);
  
        // Dados de endere√ßo de entrega
```

```diff
            codigo_transportadora: shippingMethod,
          },
-         det: lineItems,
+         det: adjustedLineItems,
        };
  
```

```diff
      return lineItems;
    }
+ 
+   /**
+    * Ajusta pre√ßos de produtos zerados seguindo regra de neg√≥cio
+    * @param {array} lineItems - Array de line items processados
+    * @param {object} shopifyData - Dados originais do Shopify
+    * @returns {array} - Line items com pre√ßos ajustados
+    */
+   async adjustZeroPriceProducts(lineItems, shopifyData) {
+     const ZERO_PRICE_REPLACEMENT = 16.50;
+     const zeroProductsCount = lineItems.filter(item => item.produto.valor_unitario === 0).length;
+     
+     if (zeroProductsCount === 0) {
+       return lineItems; // Nenhum produto com pre√ßo zero
+     }
+ 
+     const totalZeroAdjustment = zeroProductsCount * ZERO_PRICE_REPLACEMENT;
+     
+     // Log do ajuste
+     await HistoryLog.create({
+       step: 76,
+       shopify_id: shopifyData.name,
+       log: { 
+         status: 'Ajuste de produtos com pre√ßo zero iniciado',
+         produtos_zerados: zeroProductsCount,
+         valor_substituicao: ZERO_PRICE_REPLACEMENT,
+         total_ajuste: totalZeroAdjustment
+       },
+     });
+ 
+     queueLogger.info('Ajustando produtos com pre√ßo zero', {
+       shopifyId: shopifyData.name,
+       produtosZerados: zeroProductsCount,
+       valorSubstituicao: ZERO_PRICE_REPLACEMENT,
+       totalAjuste: totalZeroAdjustment,
+     });
+ 
+     // Encontrar produtos com pre√ßo maior que zero para distribuir o desconto
+     const nonZeroProducts = lineItems.filter(item => item.produto.valor_unitario > 0);
+     
+     if (nonZeroProducts.length === 0) {
+       // Todos os produtos t√™m pre√ßo zero - apenas define o pre√ßo padr√£o
+       lineItems.forEach(item => {
+         if (item.produto.valor_unitario === 0) {
+           item.produto.valor_unitario = ZERO_PRICE_REPLACEMENT;
+         }
+       });
+ 
+       await HistoryLog.create({
+         step: 77,
+         shopify_id: shopifyData.name,
+         log: { 
+           status: 'Todos os produtos tinham pre√ßo zero - aplicado pre√ßo padr√£o',
+           valor_aplicado: ZERO_PRICE_REPLACEMENT
+         },
+       });
+ 
+       return lineItems;
+     }
+ 
+     // Calcular total dos produtos com pre√ßo v√°lido
+     const totalNonZeroValue = nonZeroProducts.reduce((total, item) => {
+       return total + (item.produto.valor_unitario * item.produto.quantidade);
+     }, 0);
+ 
+     // Definir pre√ßo para produtos zerados
+     lineItems.forEach(item => {
+       if (item.produto.valor_unitario === 0) {
+         item.produto.valor_unitario = ZERO_PRICE_REPLACEMENT;
+       }
+     });
+ 
+     // Distribuir o desconto proporcionalmente entre produtos com pre√ßo v√°lido
+     let remainingAdjustment = totalZeroAdjustment;
+     
+     for (let i = 0; i < nonZeroProducts.length; i++) {
+       const item = nonZeroProducts[i];
+       const itemTotalValue = item.produto.valor_unitario * item.produto.quantidade;
+       
+       // Calcular propor√ß√£o do desconto para este item
+       let itemAdjustment;
+       if (i === nonZeroProducts.length - 1) {
+         // √öltimo item recebe o restante para evitar problemas de arredondamento
+         itemAdjustment = remainingAdjustment;
+       } else {
+         itemAdjustment = (itemTotalValue / totalNonZeroValue) * totalZeroAdjustment;
+         itemAdjustment = Math.round(itemAdjustment * 100) / 100; // Arredondar para 2 casas decimais
+       }
+ 
+       // Aplicar o desconto
+       const currentDiscount = item.produto.valor_desconto || 0;
+       item.produto.valor_desconto = currentDiscount + itemAdjustment;
+       item.produto.tipo_desconto = 'V'; // Valor absoluto
+       
+       remainingAdjustment -= itemAdjustment;
+ 
+       queueLogger.debug('Desconto aplicado ao produto', {
+         shopifyId: shopifyData.name,
+         codigoProduto: item.produto.codigo_produto,
+         valorUnitario: item.produto.valor_unitario,
+         quantidade: item.produto.quantidade,
+         descontoAnterior: currentDiscount,
+         descontoAplicado: itemAdjustment,
+         descontoTotal: item.produto.valor_desconto,
+       });
+     }
+ 
+     // Log final do ajuste
+     await HistoryLog.create({
+       step: 78,
+       shopify_id: shopifyData.name,
+       log: { 
+         status: 'Ajuste de produtos com pre√ßo zero conclu√≠do',
+         produtos_ajustados: zeroProductsCount,
+         produtos_com_desconto: nonZeroProducts.length,
+         total_desconto_distribuido: totalZeroAdjustment
+       },
+     });
+ 
+     queueLogger.info('Ajuste de produtos com pre√ßo zero conclu√≠do', {
+       shopifyId: shopifyData.name,
+       produtosAjustados: zeroProductsCount,
+       produtosComDesconto: nonZeroProducts.length,
+       totalDescontoDistribuido: totalZeroAdjustment,
+     });
+ 
+     return lineItems;
+   }
  
    /**
```

---

Agora vou atualizar a documenta√ß√£o de steps para incluir os novos steps:

---



---

Agora vou criar um arquivo de teste para verificar se o ajuste de pre√ßos est√° funcionando corretamente:

---

Cancelled

---

_**User**_

ajuste tamb√©m o que est√° sendo armazenado no log nao preciso que armazene {
  "error": "Request failed with status code 500"
} ou {
  "status": "Erro no processamento",
  "error": "Request failed with status code 500",
  "job_id": "1851"
}

preciso que armazene o retorno do omie que √© onde contem o erro

---

_**Assistant**_



---

