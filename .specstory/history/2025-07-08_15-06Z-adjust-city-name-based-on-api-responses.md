<!-- Generated by SpecStory -->

# Adjust city name based on API responses (2025-07-08 15:06Z)

_**User**_

preciso que ajuste sempre o nome da cidade baseado no retornos das apis de consulta de cep : 2025-07-08 12:06:15 [error]: OMIE API Request Error
{
  "endpoint": "/produtos/pedido/",
  "call": "IncluirPedido",
  "attempt": 1,
  "error": "Request failed with status code 500",
  "response": {
    "faultstring": "ERROR: Cidade não cadastrada para o Código [ARAUCARIA PR (PR)] ! - tag: [cCidadeOd]",
    "faultcode": "SOAP-ENV:Client-1035"
  },
  "status": 500
}

---

_**Assistant**_

Vou analisar o erro e implementar uma solução para normalizar o nome da cidade baseado nas APIs de consulta de CEP. O erro mostra que a API do OMIE não reconhece o formato "ARAUCARIA PR (PR)" e está esperando apenas "ARAUCARIA".

Primeiro, vou examinar o código atual para entender como os CEPs são consultados e como as cidades são tratadas:

---

<details>
            <summary>Grep search for "CEP|cep|cidade|city" • **4** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/services/OmieService.js` | L615 | `// Usar checkStreet e getCity igual ao Laravel` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/services/OmieService.js` | L624 | `// Buscar cidade pelo CEP igual ao Laravel` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/services/OmieService.js` | L625 | `const cityInput = shippingAddress.city;` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/services/OmieService.js` | L626 | `const city = await addressUtils.getCityByZipcode(zipcode, cityInput, shopifyData.name);` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/services/OmieService.js` | L643 | `cidade: city,` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/services/OmieService.js` | L645 | `cep: zipcode.replace(/\D/g, ''),` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/services/OmieService.js` | L754 | `case 'additional_info_shipping_city':` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/services/OmieService.js` | L755 | `fields.shipping_city = attr.value;` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/jobs/SendToOmieJob.js` | L249 | `cCEPOd: zipcode.replace(/\D/g, ''),` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/jobs/SendToOmieJob.js` | L250 | `cCidadeOd: `${shippingAddress.city} (${shippingAddress.province_code})`,` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/jobs/SendToOmieJob.js` | L509 | `case 'additional_info_shipping_city':` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/jobs/SendToOmieJob.js` | L510 | `fields.shipping_city = attr.value;` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/server.js` | L203 | `process.on('uncaughtException', (error) => {` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L44 | `* Verifica e corrige endereço usando APIs de CEP` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L46 | `* @param {string} cep` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L51 | `async checkStreet(cep, logradouro, shopifyId = null) {` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L53 | `// Remove caracteres não numéricos do CEP` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L54 | `const cleanCep = cep.replace(/[^0-9]/g, '');` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L56 | `// Verifica se é um CEP geral (terminado em 000)` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L57 | `if (cleanCep.slice(-3) === '000') {` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L65 | `const brasilApiUrl = `https://brasilapi.com.br/api/cep/v1/${cleanCep}`;` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L74 | `console.debug('Brasil API falhou, tentando ViaCEP', { cep: cleanCep });` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L77 | `// Se Brasil API falhar, tenta ViaCEP` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L80 | `const viacepUrl = `https://viacep.com.br/ws/${cleanCep}/json/`;` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L81 | `const viacepResponse = await axios.get(viacepUrl, { timeout: 5000 });` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L83 | `if (viacepResponse.data && !viacepResponse.data.erro && viacepResponse.data.logradouro) {` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L85 | `street: viacepResponse.data.logradouro` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L88 | `} catch (viacepError) {` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L89 | `console.debug('ViaCEP também falhou', { cep: cleanCep });` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L105 | `cep: cleanCep,` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L117 | `cep: cleanCep,` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L130 | `cep: cleanCep,` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L141 | `cep: cleanCep,` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L150 | `cep: cleanCep,` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L161 | `cep,` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L310 | `* Busca cidade pelo CEP seguindo padrão do Laravel` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L315 | `async getCity(zipcode, shopifyId = null) {` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L317 | `const cleanCep = zipcode.replace(/[^0-9]/g, '');` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L319 | `if (!cleanCep || cleanCep.length !== 8) {` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L320 | `return "Localidade não encontrada para o CEP informado.";` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L323 | `// Tenta primeiro ViaCEP` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L325 | `const viacepUrl = `https://viacep.com.br/ws/${cleanCep}/json/`;` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L326 | `const viacepResponse = await axios.get(viacepUrl, { timeout: 10000 });` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L328 | `if (viacepResponse.data && !viacepResponse.data.erro && viacepResponse.data.ibge) {` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L329 | `const ibgeCode = viacepResponse.data.ibge;` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L330 | `const cityName = await this.getCityByIBGE(ibgeCode);` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L332 | `await this.logAddressValidation(shopifyId, 83, 'Cidade encontrada por CEP', {` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L333 | `cep: cleanCep,` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L335 | `city_name: cityName,` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L336 | `api_used: 'ViaCEP'` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L339 | `return cityName;` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L341 | `} catch (viacepError) {` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L342 | `console.debug('ViaCEP falhou, tentando Brasil Aberto', { cep: cleanCep });` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L345 | `// Se ViaCEP falhar, tenta Brasil Aberto` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L347 | `const brasilAbertoUrl = `https://api.brasilaberto.com/v1/zipcode/${cleanCep}`;` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L352 | `const cityName = await this.getCityByIBGE(ibgeCode);` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L354 | `await this.logAddressValidation(shopifyId, 83, 'Cidade encontrada por CEP', {` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L355 | `cep: cleanCep,` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L357 | `city_name: cityName,` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L361 | `return cityName;` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/utils/addressUtils.js` | L364 | `console.debug('Brasil Aberto também falhou', { cep: cleanCep });` |

</details>

---

Read file: src/utils/addressUtils.js

---

Read file: src/jobs/SendToOmieJob.js

---

Read file: src/services/OmieService.js

---

Agora vou verificar especificamente onde está sendo aplicado o formato incorreto da cidade no SendToOmieJob.js:

---

<details>
            <summary>Grep search for "cCidadeOd.*province_code" • **1** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/jobs/SendToOmieJob.js` | L250 | `cCidadeOd: `${shippingAddress.city} (${shippingAddress.province_code})`,` |

</details>

---

Perfeito! Encontrei o problema. No arquivo `SendToOmieJob.js` na linha 250, a cidade está sendo formatada como `"ARAUCARIA (PR)"`, mas o OMIE está esperando apenas o nome da cidade sem o código do estado entre parênteses.

Vou também verificar se há outras instâncias similares:

---

<details>
            <summary>Grep search for "city.*province_code" • **1** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/jobs/SendToOmieJob.js` | L250 | `cCidadeOd: `${shippingAddress.city} (${shippingAddress.province_code})`,` |

</details>

---

Agora vou implementar a solução. O problema está no `SendToOmieJob.js` onde a cidade não está sendo normalizada usando as APIs de CEP. Vou corrigir para usar o `addressUtils.getCityByZipcode()` igual ao `OmieService.js`:

---



---

Vou ler novamente o arquivo para ver o contexto exato:

---

Read file: src/jobs/SendToOmieJob.js

---

Agora vou fazer a correção específica na linha onde a cidade está sendo formatada incorretamente:

---



---

Perfeito! Agora vou verificar se há outras partes do código que podem ter o mesmo problema. Vou verificar se há mais referências à construção de dados do pedido com cidade:

---

<details>
            <summary>Grep search for "cidade.*shippingAddress\.city" • **0** files</summary>
        
No results found
</details>

---

<details>
            <summary>Grep search for "cidade.*city" • **3** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/services/OmieService.js` | L643 | `cidade: city,` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/jobs/SendToOmieJob.js` | L254 | `cCidadeOd: city, // Usar cidade normalizada das APIs de CEP, sem province_code` |
| `file:///Users/antonioduarte/Projects/api.gummy.com.br/backend-node/src/jobs/SendToOmieJob.js` | L254 | `cCidadeOd: city, // Usar cidade normalizada das APIs de CEP, sem province_code` |

</details>

---

Ótimo! Verifico que o `OmieService.js` já está usando a cidade normalizada corretamente (linha 643), e nossa correção no `SendToOmieJob.js` agora também está seguindo o mesmo padrão.

Vou fazer um teste para verificar se a implementação está correta executando um pequeno teste:

---

```bash
cd /Users/antonioduarte/Projects/api.gummy.com.br/backend-node && node -e "
const addressUtils = require('./src/utils/addressUtils');

async function testCityNormalization() {
  console.log('Testando normalização de cidade...');
  
  // Simular um CEP de Araucária, PR
  const cep = '83707000'; // CEP exemplo de Araucária
  const cityInput = 'ARAUCARIA PR';
  
  try {
    const normalizedCity = await addressUtils.getCityByZipcode(cep, cityInput, 'TEST_ORDER');
    console.log('CEP:', cep);
    console.log('Cidade original:', cityInput);
    console.log('Cidade normalizada:', normalizedCity);
  } catch (error) {
    console.error('Erro no teste:', error.message);
  }
}

testCityNormalization();
"
```

```
Testando normalização de cidade...
Brasil Aberto também falhou { cep: '83707000' }
2025-07-08 12:09:06 [debug]: Executing (default): INSERT INTO "gummy_dev"."histo
rylog" ("id","s
tep","log","shopify_id","created_at","updated_at") VALUES (DEFAULT,$1,$2,$3,$4,$
5) RETURNING "id","step","log","shopify_id","created_at","updated_at";
                              CEP: 83707000
Cidade original: ARAUCARIA PR
Cidade normalizada: ARAUCARIA PR

```

---

Vejo que o teste mostrou que quando as APIs de CEP falham, a função retorna a cidade original como fallback. Isso está correto, mas vou otimizar a função para garantir que ela sempre retorne apenas o nome da cidade, removendo qualquer sufixo de estado.

Vou melhorar a função `getCityByZipcode` para normalizar a cidade mesmo quando as APIs falham:

---

Read file: src/utils/addressUtils.js

---

Agora vou adicionar uma função para normalizar o nome da cidade, removendo códigos de estado e outros sufixos, e vou atualizar a função `getCityByZipcode`:

---



---

Agora vou testar se a normalização está funcionando corretamente:

---

```bash
node -e "
const addressUtils = require('./src/utils/addressUtils');

async function testCityNormalization() {
  console.log('=== Testando normalização de cidade ===');
  
  // Teste casos diversos
  const testCases = [
    { input: 'ARAUCARIA (PR)', expected: 'ARAUCARIA' },
    { input: 'ARAUCARIA PR', expected: 'ARAUCARIA' },
    { input: 'SAO PAULO SP', expected: 'SAO PAULO' },
    { input: 'RIO DE JANEIRO (RJ)', expected: 'RIO DE JANEIRO' },
    { input: 'BELO HORIZONTE', expected: 'BELO HORIZONTE' }, // sem estado
    { input: 'CURITIBA PR (PR)', expected: 'CURITIBA' }, // duplo
  ];
  
  testCases.forEach(testCase => {
    const result = addressUtils.normalizeCityName(testCase.input);
    const status = result === testCase.expected ? '✅' : '❌';
    console.log(\`\${status} '\${testCase.input}' -> '\${result}' (esperado: '\${testCase.expected}')\`);
  });
  
  console.log('\\n=== Testando getCityByZipcode com fallback ===');
  
  // Simular um CEP que vai falhar para testar o fallback
  const cep = '00000000'; // CEP inválido
  const cityInput = 'ARAUCARIA PR (PR)';
  
  try {
    const normalizedCity = await addressUtils.getCityByZipcode(cep, cityInput, 'TEST_ORDER');
    console.log('CEP:', cep);
    console.log('Cidade original:', cityInput);
    console.log('Cidade normalizada:', normalizedCity);
  } catch (error) {
    console.error('Erro no teste:', error.message);
  }
}

testCityNormalization();
"
```

```
<ssage);\n  }\n}\n\ntestCityNormalization();\n"
=== Testando normalização de cidade ===
✅ 'ARAUCARIA (PR)' -> 'ARAUCARIA' (esperado: 'ARAUCARIA')
✅ 'ARAUCARIA PR' -> 'ARAUCARIA' (esperado: 'ARAUCARIA')
✅ 'SAO PAULO SP' -> 'SAO PAULO' (esperado: 'SAO PAULO')
✅ 'RIO DE JANEIRO (RJ)' -> 'RIO DE JANEIRO' (esperado: 'RIO DE JANEIRO')
✅ 'BELO HORIZONTE' -> 'BELO HORIZONTE' (esperado: 'BELO HORIZONTE')
✅ 'CURITIBA PR (PR)' -> 'CURITIBA' (esperado: 'CURITIBA')

=== Testando getCityByZipcode com fallback ===
Brasil Aberto também falhou { cep: '00000000' }
2025-07-08 12:09:53 [debug]: Executing (default): INSERT INTO "gummy_dev"."historylog" ("id","s
tep","log","shopify_id","created_at","updated_at") VALUES (DEFAULT,$1,$2,$3,$4,$5) RETURNING "i
d","step","log","shopify_id","created_at","updated_at";
2025-07-08 12:09:53 [debug]: Executing (default): INSERT INTO "gummy_dev"."historylog" ("id","s
tep","log","shopify_id","created_at","updated_at") VALUES (DEFAULT,$1,$2,$3,$4,$5) RETURNING "i
d","step","log","shopify_id","created_at","updated_at";
CEP: 00000000
Cidade original: ARAUCARIA PR (PR)
Cidade normalizada: ARAUCARIA
antonioduarte@MacBook-Air-de-Antonio backend-node %
```

---

Excelente! A normalização está funcionando perfeitamente. Todos os testes passaram:

✅ `'ARAUCARIA (PR)'` → `'ARAUCARIA'`
✅ `'ARAUCARIA PR'` → `'ARAUCARIA'` 
✅ `'SAO PAULO SP'` → `'SAO PAULO'`
✅ `'RIO DE JANEIRO (RJ)'` → `'RIO DE JANEIRO'`
✅ `'BELO HORIZONTE'` → `'BELO HORIZONTE'`
✅ `'CURITIBA PR (PR)'` → `'CURITIBA'`

E o teste com CEP inválido também funcionou corretamente, retornando `'ARAUCARIA'` em vez de `'ARAUCARIA PR (PR)'`.

Agora vou verificar se há algum teste no projeto para garantir que nossa alteração não quebrou nada:

---

```bash
npm test
```

```
antonioduarte@MacBook-Air-de-Antonio backend-node % npm test

> central-gummy-api@1.0.0 test
> NODE_ENV=test jest

● Validation Warning:

  Unknown option "moduleNameMapping" with value {"^@/(.*)$": "<rootDir>/src/$1", "^@config/(.*)
$": "<rootDir>/src/config/$1", "^@controllers/(.*)$": "<rootDir>/src/controllers/$1", "^@jobs/(
.*)$": "<rootDir>/src/jobs/$1", "^@models/(.*)$": "<rootDir>/src/models/$1", "^@services/(.*)$"
: "<rootDir>/src/services/$1", "^@utils/(.*)$": "<rootDir>/src/utils/$1"} was found.
  This is probably a typing mistake. Fixing it will remove this message.

  Configuration Documentation:
  https://jestjs.io/docs/configuration

● Validation Error:

  Module <rootDir>/tests/setup.js in the setupFilesAfterEnv option was not found.
         <rootDir> is: /Users/antonioduarte/Projects/api.gummy.com.br/backend-node

  Configuration Documentation:
  https://jestjs.io/docs/configuration

antonioduarte@MacBook-Air-de-Antonio backend-node %
```

---

Vou verificar a configuração do Jest:

---

Read file: jest.config.js

---

_**User**_

preciso de dois endpoints, um que retorne todos os logs com paginação, e um que retorne apenas os pedidos desse filtro agrupado por id da shopify: SELECT *
FROM nutringroup.gummy_dev.historylog h
WHERE
    LOWER(h.log::text) ~ 'erro|fail|invalid|denied|bad request|unauthorized|not found|cidade n[aã]o encontrada'
 

---

_**Assistant**_



---

